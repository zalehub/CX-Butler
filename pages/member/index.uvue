<template>
	<view class="container">
		<!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
		<view class="header">
			<text class="header-title">ä¼šå‘˜ä¸­å¿ƒ</text>
		</view>
		
		<!-- ä¼šå‘˜ä¿¡æ¯å¡ç‰‡ -->
		<view class="member-card">
			<view class="member-info">
				<view class="avatar-container">
					<image class="avatar" src="/static/default_avatar.svg"></image>
				</view>
				<view class="info-container">
					<text class="member-name">{{userInfo.nickname || 'æœªç™»å½•'}}</text>
					<view class="level-container" v-if="userInfo.isLogin">
						<text class="level-tag">{{getLevelName()}}</text>
						<text class="member-id">ID: {{userInfo.memberId}}</text>
					</view>
					<text class="login-btn" v-else @click="goToLogin">ç‚¹å‡»ç™»å½•/æ³¨å†Œ</text>
				</view>
			</view>
			<view class="member-stats" v-if="userInfo.isLogin">
				<view class="stat-item">
					<text class="stat-value">{{userInfo.points}}</text>
					<text class="stat-label">ç§¯åˆ†</text>
				</view>
				<view class="stat-item">
					<text class="stat-value">{{userInfo.balance}}å…ƒ</text>
					<text class="stat-label">ä½£é‡‘ä½™é¢</text>
				</view>
				<view class="stat-item">
					<text class="stat-value">{{userInfo.teamCount}}äºº</text>
					<text class="stat-label">å›¢é˜Ÿæˆå‘˜</text>
				</view>
			</view>
		</view>
		
		<!-- ä¼šå‘˜åŠŸèƒ½åŒº -->
		<view class="function-section">
			<view class="section-header">
				<text class="section-title">ä¼šå‘˜åŠŸèƒ½</text>
			</view>
			<view class="function-grid">
				<view class="function-item" @click="navigateTo('memberInfo')">
					<image class="function-icon" src="/static/member_info.svg"></image>
					<text class="function-text">ä¸ªäººèµ„æ–™</text>
				</view>
				<view class="function-item" @click="navigateTo('points')">
					<image class="function-icon" src="/static/points.svg"></image>
					<text class="function-text">ç§¯åˆ†ç®¡ç†</text>
				</view>
				<view class="function-item" @click="navigateTo('commission')">
					<image class="function-icon" src="/static/commission.svg"></image>
					<text class="function-text">ä½£é‡‘ç®¡ç†</text>
				</view>
				<view class="function-item" @click="navigateTo('team')">
					<image class="function-icon" src="/static/team.svg"></image>
					<text class="function-text">æˆ‘çš„å›¢é˜Ÿ</text>
				</view>
				<view class="function-item" @click="navigateTo('invite')">
					<image class="function-icon" src="/static/invite.svg"></image>
					<text class="function-text">é‚€è¯·å¥½å‹</text>
				</view>
				<view class="function-item" @click="navigateTo('level')">
					<image class="function-icon" src="/static/level.svg"></image>
					<text class="function-text">ç­‰çº§ç‰¹æƒ</text>
				</view>
			</view>
		</view>
		
		<!-- æˆ‘çš„è®¢å• -->
		<view class="order-section" v-if="userInfo.isLogin">
			<view class="section-header">
				<text class="section-title">æˆ‘çš„è®¢å•</text>
				<text class="more-link" @click="navigateTo('orders')">æŸ¥çœ‹å…¨éƒ¨ ></text>
			</view>
			<view class="order-status">
				<view class="status-item" @click="navigateTo('orders', {status: 'pending'})">
					<image class="status-icon" src="/static/pending.svg"></image>
					<text class="status-text">å¾…å¤„ç†</text>
					<text class="status-badge" v-if="orderStats.pending > 0">{{orderStats.pending}}</text>
				</view>
				<view class="status-item" @click="navigateTo('orders', {status: 'processing'})">
					<image class="status-icon" src="/static/processing.svg"></image>
					<text class="status-text">å¤„ç†ä¸­</text>
					<text class="status-badge" v-if="orderStats.processing > 0">{{orderStats.processing}}</text>
				</view>
				<view class="status-item" @click="navigateTo('orders', {status: 'completed'})">
					<image class="status-icon" src="/static/completed.svg"></image>
					<text class="status-text">å·²å®Œæˆ</text>
				</view>
				<view class="status-item" @click="navigateTo('orders', {status: 'cancelled'})">
					<image class="status-icon" src="/static/cancelled.svg"></image>
					<text class="status-text">å·²å–æ¶ˆ</text>
				</view>
			</view>
		</view>
		
		<!-- åº•éƒ¨å¯¼èˆªæ  -->
		<view class="tab-bar">
			<view class="tab-item" @click="switchTab('index')">
				<text class="tab-icon">ğŸ </text>
				<text class="tab-text">é¦–é¡µ</text>
			</view>
			<view class="tab-item" @click="switchTab('policy')">
				<text class="tab-icon">ğŸ“‹</text>
				<text class="tab-text">ä¿å•</text>
			</view>
			<view class="tab-item" @click="switchTab('commission')">
				<text class="tab-icon">ğŸ’°</text>
				<text class="tab-text">ä½£é‡‘</text>
			</view>
			<view class="tab-item active">
				<text class="tab-icon">ğŸ‘¤</text>
				<text class="tab-text">æˆ‘çš„</text>
			</view>
		</view>
	</view>
</template>

<script>
	export default {
		data() {
			return {
				title: 'ä¼šå‘˜ä¸­å¿ƒ',
				// ç”¨æˆ·ä¿¡æ¯
				userInfo: {
					isLogin: false,
					memberId: '',
					nickname: '',
					level: 0, // 0: æ™®é€šç”¨æˆ·, 1: é’é“œ, 2: ç™½é“¶, 3: é»„é‡‘, 4: é“‚é‡‘, 5: é’»çŸ³
					points: 0,
					balance: 0,
					teamCount: 0,
					inviteCode: ''
				},
				// è®¢å•ç»Ÿè®¡
				orderStats: {
					pending: 0,
					processing: 0
				}
			}
		},
		onLoad() {
			console.log('ä¼šå‘˜ä¸­å¿ƒé¡µé¢åŠ è½½')
			// åŠ è½½ç”¨æˆ·ä¿¡æ¯
			this.loadUserInfo()
		},
		methods: {
			// åŠ è½½ç”¨æˆ·ä¿¡æ¯
			loadUserInfo() {
				// ä»æœ¬åœ°å­˜å‚¨è·å–ç”¨æˆ·ä¿¡æ¯
				try {
					const userInfoStr = uni.getStorageSync('userInfo')
					console.log('è·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯:', userInfoStr)
					if (userInfoStr) {
						const userInfo = JSON.parse(userInfoStr)
						this.userInfo = userInfo
						console.log('è§£æåçš„ç”¨æˆ·ä¿¡æ¯:', this.userInfo)
						
						// åŠ è½½è®¢å•ç»Ÿè®¡æ•°æ®
						this.loadOrderStats()
					} else {
						// æœªç™»å½•çŠ¶æ€ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
						this.userInfo = {
							isLogin: false,
							memberId: '',
							nickname: '',
							level: 0,
							points: 0,
							balance: 0,
							teamCount: 0,
							inviteCode: ''
						}
						this.orderStats = {
							pending: 0,
							processing: 0
						}
					}
				} catch (e) {
					console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', e)
					// ä½¿ç”¨é»˜è®¤æ•°æ®
					this.userInfo = {
						isLogin: false,
						memberId: '',
						nickname: '',
						level: 0,
						points: 0,
						balance: 0,
						teamCount: 0,
						inviteCode: ''
					}
					this.orderStats = {
						pending: 0,
						processing: 0
					}
				}
			},
			
			// åŠ è½½è®¢å•ç»Ÿè®¡æ•°æ®
			loadOrderStats() {
				// å®é™…åº”ç”¨ä¸­åº”è¯¥ä»APIè·å–æ•°æ®
				// è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
				if (this.userInfo.isLogin) {
					this.orderStats = {
						pending: 2,
						processing: 1
					}
				}
			},
			
			// è·å–ä¼šå‘˜ç­‰çº§åç§°
			getLevelName() {
				const levelNames = ['æ™®é€šç”¨æˆ·', 'é’é“œä¼šå‘˜', 'ç™½é“¶ä¼šå‘˜', 'é»„é‡‘ä¼šå‘˜', 'é“‚é‡‘ä¼šå‘˜', 'é’»çŸ³ä¼šå‘˜']
				return levelNames[this.userInfo.level] || 'æ™®é€šç”¨æˆ·'
			},
			
			// è·³è½¬åˆ°ç™»å½•é¡µé¢
			goToLogin() {
				uni.navigateTo({
					url: '/pages/member/login'
				})
			},
			
			// å¯¼èˆªåˆ°å…¶ä»–é¡µé¢
			navigateTo(page, params = {}) {
				// å¦‚æœæœªç™»å½•ä¸”è®¿é—®éœ€è¦ç™»å½•çš„é¡µé¢ï¼Œåˆ™è·³è½¬åˆ°ç™»å½•é¡µ
				const needLoginPages = ['memberInfo', 'points', 'commission', 'team', 'invite', 'level', 'orders']
				if (!this.userInfo.isLogin && needLoginPages.includes(page)) {
					this.goToLogin()
					return
				}
				
				// æ„å»ºURLå‚æ•°
				let paramsStr = ''
				if (Object.keys(params).length > 0) {
					paramsStr = '?' + Object.keys(params)
						.map(key => `${key}=${encodeURIComponent(params[key])}`)
						.join('&')
				}
				
				// é¡µé¢æ˜ å°„
				const pageMap = {
					memberInfo: '/pages/member/info',
					points: '/pages/member/points', // ç§¯åˆ†å•†åŸé¡µé¢
					commission: '/pages/member/commission',
					team: '/pages/member/team',
					invite: '/pages/member/invite',
					level: '/pages/member/level',
					orders: '/pages/member/orders'
				}
				
				if (pageMap[page]) {
					uni.navigateTo({
						url: pageMap[page] + paramsStr
					})
				}
			},
			
			// åˆ‡æ¢åº•éƒ¨æ ‡ç­¾
			switchTab(tab) {
				if (tab === 'index') {
					uni.switchTab({
						url: '/pages/index/index'
					})
				}
				// å…¶ä»–æ ‡ç­¾é¡µå¾…å®ç°
			}
		}
	}
</script>

<style>
	.container {
		flex-direction: column;
		background-color: #F5F7FA;
		padding-bottom: 50px;
	}
	
	/* é¡¶éƒ¨æ ‡é¢˜æ  */
	.header {
		height: 50px;
		background-color: #1E90FF;
		justify-content: center;
		align-items: center;
	}
	
	.header-title {
		color: #FFFFFF;
		font-size: 18px;
		font-weight: bold;
	}
	
	/* ä¼šå‘˜ä¿¡æ¯å¡ç‰‡ */
	.member-card {
		margin: 15px;
		background-color: #FFFFFF;
		border-radius: 12px;
		padding: 15px;
		box-shadow: 0 4px 12px rgba(0,0,0,0.08);
	}
	
	.member-info {
		flex-direction: row;
		align-items: center;
		margin-bottom: 15px;
	}
	
	.avatar-container {
		width: 70px;
		height: 70px;
		border-radius: 35px;
		overflow: hidden;
		margin-right: 15px;
		border-width: 2px;
		border-color: #1E90FF;
	}
	
	.avatar {
		width: 70px;
		height: 70px;
	}
	
	.info-container {
		flex: 1;
	}
	
	.member-name {
		font-size: 18px;
		font-weight: bold;
		color: #333333;
		margin-bottom: 5px;
	}
	
	.level-container {
		flex-direction: row;
		align-items: center;
	}
	
	.level-tag {
		background-color: #FFD700;
		color: #333333;
		font-size: 12px;
		padding: 2px 8px;
		border-radius: 10px;
		margin-right: 10px;
	}
	
	.member-id {
		font-size: 12px;
		color: #666666;
	}
	
	.login-btn {
		color: #1E90FF;
		font-size: 14px;
		margin-top: 5px;
	}
	
	.member-stats {
		flex-direction: row;
		justify-content: space-around;
		padding-top: 15px;
		border-top-width: 1px;
		border-top-color: #EEEEEE;
	}
	
	.stat-item {
		align-items: center;
	}
	
	.stat-value {
		font-size: 16px;
		font-weight: bold;
		color: #333333;
		margin-bottom: 5px;
	}
	
	.stat-label {
		font-size: 12px;
		color: #666666;
	}
	
	/* ä¼šå‘˜åŠŸèƒ½åŒº */
	.function-section {
		margin: 15px;
		background-color: #FFFFFF;
		border-radius: 12px;
		padding: 15px;
		box-shadow: 0 4px 12px rgba(0,0,0,0.08);
	}
	
	.section-header {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 15px;
	}
	
	.section-title {
		font-size: 16px;
		font-weight: bold;
		color: #333333;
	}
	
	.more-link {
		font-size: 12px;
		color: #666666;
	}
	
	.function-grid {
		flex-direction: row;
		flex-wrap: wrap;
	}
	
	.function-item {
		width: 33.33%;
		align-items: center;
		padding: 10px 0;
	}
	
	.function-icon {
		width: 40px;
		height: 40px;
		margin-bottom: 5px;
	}
	
	.function-text {
		font-size: 12px;
		color: #666666;
	}
	
	/* è®¢å•åŒºåŸŸ */
	.order-section {
		margin: 15px;
		background-color: #FFFFFF;
		border-radius: 12px;
		padding: 15px;
		box-shadow: 0 4px 12px rgba(0,0,0,0.08);
	}
	
	.order-status {
		flex-direction: row;
		justify-content: space-around;
	}
	
	.status-item {
		align-items: center;
		position: relative;
	}
	
	.status-icon {
		width: 30px;
		height: 30px;
		margin-bottom: 5px;
	}
	
	.status-text {
		font-size: 12px;
		color: #666666;
	}
	
	.status-badge {
		position: absolute;
		top: -5px;
		right: -5px;
		background-color: #FF3B30;
		color: #FFFFFF;
		font-size: 10px;
		width: 16px;
		height: 16px;
		border-radius: 8px;
		text-align: center;
		line-height: 16px;
	}
	
	/* åº•éƒ¨å¯¼èˆªæ  */
	.tab-bar {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
		height: 50px;
		background-color: #FFFFFF;
		flex-direction: row;
		justify-content: space-around;
		align-items: center;
		border-top-width: 1px;
		border-top-color: #EEEEEE;
		box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
	}
	
	.tab-item {
		align-items: center;
		padding: 5px 0;
	}
	
	.tab-icon {
		font-size: 20px;
		margin-bottom: 2px;
	}
	
	.tab-text {
		font-size: 10px;
		color: #666666;
	}
	
	.tab-item.active .tab-text {
		color: #1E90FF;
	}
</style>